<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ë“¤ë§ˆë£¨ ë§ˆì´í˜ì´ì§€</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/deulmaru_MyPage.css}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- jQuery UI CSS -->
	<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
	<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
</head>
<body>
    <!-- í—¤ë” ì‚½ì… -->
    <div th:replace="layout/header :: header"></div>

    <!-- ë³‘í•´ì¶© ì¡°íšŒ ë°°ë„ˆ-->
    <div class="container-sm text-center w-50">
        <div class="banner-content text-center">
            <h2>ë§ˆì´ í˜ì´ì§€</h2>
            <p>íšŒì› ì •ë³´ë¥¼ ìˆ˜ì •í•˜ê³  í™œë™ íˆìŠ¤í† ë¦¬ë¥¼ ì¡°íšŒí•˜ì„¸ìš”</p>
        </div>
    </div>

    <!-- ë©”ë‰´ íƒ­ -->
	<div class="container-sm tab-menu">
	    <button class="tab-button active" data-tab="profileTab" onclick="showTab('profileTab')">ë‚´ í”„ë¡œí•„</button> 
	    <button class="tab-button" data-tab="diagHistoryTab" onclick="showTab('diagHistoryTab')">AI ì§„ë‹¨ ì´ë ¥</button> 
	    <button class="tab-button" data-tab="benefitTab" onclick="showTab('benefitTab')">ì§€ì›ê¸ˆ</button> 
	</div>

    <!-- íƒ­ ì½˜í…ì¸  -->
    <div class="tab-content-container container-sm w-75">
        <!-- ë‚´ í”„ë¡œí•„ íƒ­ -->
        <div class="tab-content" id="profileTab"> 
            <!-- ì—…ë°ì´íŠ¸ í¼ -->
            <form action="/mypage/update-profile" method="post">
                <div class="input-group mb-3">
                    <span class="input-group-text">ë‹‰ë„¤ì„</span>
                    <input type="text" class="form-control" th:value="${session.user.userNickname}" name="userNickname" required>
                </div>

                <div class="input-group mb-3">
                    <span class="input-group-text">ì´ë©”ì¼</span>
                    <input type="text" class="form-control" th:value="${session.user.userEmail}" disabled>
                </div>

                <div class="input-group mb-3">
                    <span class="input-group-text">ì•„ì´ë””</span>
                    <input type="text" class="form-control" th:value="${session.user.userId}" disabled>
                </div>

                <div class="input-group mb-3">
                    <span class="input-group-text">ë¹„ë°€ë²ˆí˜¸</span>
                    <input type="password" class="form-control" name="userPw" placeholder="ë³€ê²½í•  ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
                </div>

				<div class="input-group">
				    <span class="input-group-text">ì£¼ì†Œì§€</span>
				    <select class="form-select" name="userLocate">
				        <option th:selected="${session.user.userLocate == 'ì„œìš¸'}" value="ì„œìš¸">ì„œìš¸</option>
				        <option th:selected="${session.user.userLocate == 'ë¶€ì‚°'}" value="ë¶€ì‚°">ë¶€ì‚°</option>
				        <option th:selected="${session.user.userLocate == 'ëŒ€êµ¬'}" value="ëŒ€êµ¬">ëŒ€êµ¬</option>
				        <option th:selected="${session.user.userLocate == 'ì¸ì²œ'}" value="ì¸ì²œ">ì¸ì²œ</option>
				        <option th:selected="${session.user.userLocate == 'ê´‘ì£¼'}" value="ê´‘ì£¼">ê´‘ì£¼</option>
				        <option th:selected="${session.user.userLocate == 'ëŒ€ì „'}" value="ëŒ€ì „">ëŒ€ì „</option>
				        <option th:selected="${session.user.userLocate == 'ìš¸ì‚°'}" value="ìš¸ì‚°">ìš¸ì‚°</option>
				        <option th:selected="${session.user.userLocate == 'ì„¸ì¢…'}" value="ì„¸ì¢…">ì„¸ì¢…</option>
				        <option th:selected="${session.user.userLocate == 'ê²½ê¸°'}" value="ê²½ê¸°">ê²½ê¸°</option>
				        <option th:selected="${session.user.userLocate == 'ê°•ì›'}" value="ê°•ì›">ê°•ì›</option>
				        <option th:selected="${session.user.userLocate == 'ì¶©ë¶'}" value="ì¶©ë¶">ì¶©ë¶</option>
				        <option th:selected="${session.user.userLocate == 'ì¶©ë‚¨'}" value="ì¶©ë‚¨">ì¶©ë‚¨</option>
				        <option th:selected="${session.user.userLocate == 'ì „ë¶'}" value="ì „ë¶">ì „ë¶</option>
				        <option th:selected="${session.user.userLocate == 'ì „ë‚¨'}" value="ì „ë‚¨">ì „ë‚¨</option>
				        <option th:selected="${session.user.userLocate == 'ê²½ë¶'}" value="ê²½ë¶">ê²½ë¶</option>
				        <option th:selected="${session.user.userLocate == 'ê²½ë‚¨'}" value="ê²½ë‚¨">ê²½ë‚¨</option>
				        <option th:selected="${session.user.userLocate == 'ì œì£¼'}" value="ì œì£¼">ì œì£¼</option>
				    </select>
				</div>
				
				    <!-- ì¬ë°°ì‘ë¬¼ ì„ íƒ ì˜ì—­ -->
				<div class="input-group mb-3">
			    <span class="input-group-text">ì¬ë°°ì‘ë¬¼</span>
			    <!-- ì‚¬ìš©ìê°€ ì´ì „ì— ì„ íƒí•œ ì‘ë¬¼ëª…ì´ ìˆìœ¼ë©´ ë¯¸ë¦¬ ì±„ì›Œì¤ë‹ˆë‹¤ -->
			    <input type="text" id="cropInput" class="form-control" placeholder="ì‘ë¬¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" th:value="${session.user.userCrop}">
			    <!-- íˆë“  í•„ë“œë„ ë¯¸ë¦¬ ì±„ì›Œì¤ë‹ˆë‹¤ -->
			    <input type="hidden" name="userCrop" id="userCrop" th:value="${session.user.userCrop}">
				</div>

                <div class="button-group text-end mt-4">
                    <button type="button" class="btn btn-outline-secondary me-2">ì·¨ì†Œ</button>
                    <button class="btn btn-primary" type="submit">ìˆ˜ì •</button>
                </div>
            </form>

            <!-- ì¹´ì¹´ì˜¤ ê³„ì •ì´ ì—°ë™ëœ ê²½ìš° -->
            <div th:if="${session.user != null and session.user.kakaoId != null}" class="mt-4">
                <p>í˜„ì¬ ì¹´ì¹´ì˜¤ ê³„ì •ê³¼ ì—°ë™ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
                <form action="/auth/kakao/unlink" method="post">
                    <button type="submit" class="btn btn-danger">ì¹´ì¹´ì˜¤ ì—°ë™ í•´ì œ</button>
                </form>
            </div>

            <!-- ì¹´ì¹´ì˜¤ ê³„ì •ì´ ì—°ë™ë˜ì§€ ì•Šì€ ê²½ìš° -->
            <div th:if="${session.user != null and session.user.kakaoId == null}" class="mt-4">
                <p>ì¹´ì¹´ì˜¤ ê³„ì •ì´ ì—°ë™ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                <a href="/auth/kakao/link" class="btn btn-primary">ì¹´ì¹´ì˜¤ ê³„ì • ì—°ë™í•˜ê¸°</a>
            </div>
        </div> <!-- ì—¬ê¸°ì„œ ë‚´ í”„ë¡œí•„ íƒ­ì„ ë‹«ì•„ì•¼ í•©ë‹ˆë‹¤. -->

        <!-- AI ì§„ë‹¨ ì´ë ¥ íƒ­ -->
		<!-- AI ì§„ë‹¨ ì´ë ¥ íƒ­ -->
		<div class="tab-content hidden" id="diagHistoryTab">
		    <table class="table table-bordered text-left">
		        <thead class="table-dark">
		            <tr>
		                <th>ì§„ë‹¨ ë‚ ì§œ</th>
		                <th>ì‘ë¬¼ëª…</th>
		                <th>ë³‘í•´ì¶© ëª…</th>
		                <th>ì •í™•ë„</th>
		                <th>ì§„ë‹¨ ì´ë¯¸ì§€</th>
						<th>ì§„ë‹¨ ì´ë ¥ ì‚­ì œ</th>
		            </tr>
		        </thead>
				<tbody>
				    <tr th:if="${#lists.isEmpty(identiHistory)}">
				        <td colspan="5">ì§„ë‹¨ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</td>
				    </tr>
				    <tr th:each="history : ${identiHistory}">
				        <td th:text="${#temporals.format(history.identificationTime, 'yyyy-MM-dd HH:mm:ss')}"></td>
				        <td th:text="${history.cropName}"></td>
				        <td th:text="${history.diseaseName}"></td>
				        <td th:text="${history.confidenceScore + '%'}"></td>
						<td>
						    <img th:src="@{'/uploads/' + ${#strings.substring(history.imagePath, history.imagePath.lastIndexOf('/') + 1)}}"
						         alt="ì§„ë‹¨ ì´ë¯¸ì§€" class="img-thumbnail"
						         style="width:100px; height:auto; cursor:pointer;"
						         onclick="openImageModal(this.src)">
						</td>
				    </tr>
				</tbody>


		    </table>
		</div>
		
		<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
		  <div class="modal-dialog modal-dialog-centered modal-lg">
		    <div class="modal-content">
		      <div class="modal-body text-center">
		        <img id="modalImage" src="" alt="ì§„ë‹¨ ì´ë¯¸ì§€ í™•ëŒ€" class="img-fluid" style="max-height: 600px;">
		      </div>
		    </div>
		  </div>
		</div> 

		<script>
			// ì—…ë¡œë“œ ì´ë¯¸ì§€ í™•ëŒ€
		function openImageModal(imageSrc) {
		    // ì´ë¯¸ì§€ ê²½ë¡œ ì„¤ì •
		    document.getElementById("modalImage").src = imageSrc;
		    // Bootstrap ëª¨ë‹¬ ì—´ê¸°
		    const modal = new bootstrap.Modal(document.getElementById("imageModal"));
		    modal.show();
		}
		</script>


        <!-- ì§€ì›ê¸ˆ íƒ­ -->
        <div class="tab-content hidden" id="benefitTab">
            <ul class="benefit-list d-flex flex-wrap">
                <li class="card benefit-card">
                    <div class="card-body">
                        <h3 class="card-title">ê·€ë†ê·€ì´Œì •ì±… | ë†ì´Œ ì •ì±… ì§€ì›</h3>
                        <p class="card-text"><strong>ëŒ€ìƒ :</strong> ê¹€í¬ì£¼ë¯¼</p>
                        <p class="date-range"><strong>ì‹ ì²­ê¸°ê°„ :</strong> 2025.02.11 ~ 2025.05.10</p>
                        <p class="card-ongoing"><strong>ì§„í–‰ ìƒíƒœ :</strong> ë§ˆê°</p>
                        <button class="show-more">ìƒì„¸ë³´ê¸°</button>
                    </div>
                </li>
            </ul>
        </div>
    </div>

	<!-- ë‚˜ì˜ ì‘ë¬¼ ì¬ë°° ì¼ì • -->
	<div class="container-sm text-left" id="cropScheduleArea">
	    <div class="agri-calendar">
	        <h3>ë‚˜ì˜ ì‘ë¬¼ ì¬ë°° ì¼ì •</h3>
	        <!-- API ê²°ê³¼ë¡œ ë°›ì€ HTML í…œí”Œë¦¿ì„ ì‚½ì…í•  ì˜ì—­ -->
	        <div id="cropScheduleContent">
	            <p>ì¬ë°°ì‘ë¬¼ì„ ì„ íƒí•˜ë©´ ì¼ì •ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
	        </div>
	    </div>
	</div>

    <script src="/js/deulmaru_const.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
	
    <script>
		
 // (1) ê´€ì‹¬ ì§€ì›ê¸ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì™€ ê° ì§€ì›ê¸ˆ ìƒì„¸ ì •ë³´ë¥¼ í˜¸ì¶œí•˜ê³  ì¹´ë“œ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
    function loadInterestGrants() {
        // ìš°ì„  benefitTab ë‚´ì˜ ê¸°ì¡´ ULì„ ì°¾ê±°ë‚˜ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
        var $ulContainer = $("#benefitTab ul.benefit-list");
        if ($ulContainer.length === 0) {
            $("#benefitTab").html('<ul class="benefit-list d-flex flex-wrap"></ul>');
            $ulContainer = $("#benefitTab ul.benefit-list");
        }
        
        // ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ (UL ë‚´ë¶€ ë‚´ìš© ì´ˆê¸°í™”)
        $ulContainer.html("<p>ê´€ì‹¬ ì§€ì›ê¸ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>");
        
        // â‘  ê´€ì‹¬ ì§€ì›ê¸ˆ ëª©ë¡ API í˜¸ì¶œ
        $.ajax({
            url: "/api/interest/list",
            type: "GET",
            dataType: "json",
            success: function(interests) {
                // ê´€ì‹¬ ë“±ë¡í•œ í•­ëª©ì´ ì—†ìœ¼ë©´ ë©”ì‹œì§€ ì¶œë ¥
                if (!interests || interests.length === 0) {
                    $ulContainer.html("<p>ê´€ì‹¬ ë“±ë¡ëœ ì§€ì›ê¸ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>");
                    return;
                }
                // ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
                $ulContainer.empty();
                
                // â‘¡ ê° ê´€ì‹¬ í•­ëª©ì— ëŒ€í•´ ì§€ì›ê¸ˆ ìƒì„¸ ì •ë³´ë¥¼ í˜¸ì¶œ
                interests.forEach(function(interest) {
                    var grantId = interest.grantId;
                    
                    $.ajax({
                        url: "https://apis.data.go.kr/1390000/youngV2/policyViewV2",
                        type: "GET",
                        dataType: "json",
                        data: {
                            typeDv: "json",
                            serviceKey: "lwFN+9DgtdnDkUuQpxCaemhEBXNKBw/EIeII2WsOlInuroAHa9InabfXhyR365jieyuEEzrb2QYAHP3b3AlrFA==",
                            seq: grantId
                        },
                        success: function(response) {
                            // ì™¸ë¶€ APIì˜ ì‘ë‹µì—ì„œ ì§€ì›ê¸ˆ ìƒì„¸ ì •ë³´ë¥¼ ì¶”ì¶œ
                            var grant = response.policy_result;
                            // ì§„í–‰ ìƒíƒœ ê³„ì‚° (applEdDtë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì§„í–‰ì¤‘/ë§ˆê° íŒë‹¨)
                            var status = getStatus(grant.applEdDt);
                            
                            // ì¹´ë“œ í…œí”Œë¦¿ ìƒì„± (ê¸°ì¡´ HTML êµ¬ì¡°ì™€ ë™ì¼í•˜ê²Œ <li> ìš”ì†Œë¡œ ìƒì„±)
							var cardHtml = `
							    <li class="card benefit-card">
							        <div class="card-body">
							            <h3 class="card-title">${grant.title || "ì œëª© ì—†ìŒ"}</h3>
							            <p class="card-text"><strong>ëŒ€ìƒ :</strong> ${grant.eduTarget || "ëŒ€ìƒ ì •ë³´ ì—†ìŒ"}</p>
							            <p class="date-range"><strong>ì‹ ì²­ê¸°ê°„ :</strong> ${grant.applStDt || "ê¸°ê°„ ì—†ìŒ"} ~ ${grant.applEdDt || "ê¸°ê°„ ì—†ìŒ"}</p>
							            <p class="card-ongoing">
							                <strong>ì§„í–‰ ìƒíƒœ :</strong>
							                <span class="${status === 'ì§„í–‰ì¤‘' ? 'ongoing' : 'closed'}">${status}</span>
							            </p>
							            <button class="show-more" onclick="window.location.href='/supportApi/detail/${grant.seq}'">ìƒì„¸ë³´ê¸°</button>
							            <button class="cancel-interest-btn" data-grant-id="${grant.seq}">ê´€ì‹¬ ì·¨ì†Œ</button>
							        </div>
							    </li>
							`;

                            // UL ì»¨í…Œì´ë„ˆì— ì¹´ë“œ ì¶”ê°€
                            $ulContainer.append(cardHtml);
                        },
                        error: function() {
                            console.error("ì§€ì›ê¸ˆ ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (grantId: " + grantId + ")");
                        }
                    });
                });
            },
            error: function() {
                $ulContainer.html("<p>ê´€ì‹¬ ì§€ì›ê¸ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>");
            }
        });
    }

    // ì§„í–‰ ìƒíƒœë¥¼ ê³„ì‚°í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
    function getStatus(applEdDt) {
        if (!applEdDt) return "ì •ë³´ ì—†ìŒ";
        var today = new Date();
        var endDate = new Date(applEdDt);
        if (isNaN(endDate.getTime())) return "ì •ë³´ ì—†ìŒ";
        return today <= endDate ? "ì§„í–‰ì¤‘" : "ë§ˆê°";
    }
	
    
    // ê´€ì‹¬ë“±ë¡ ì·¨ì†Œ ë²„íŠ¼ ì´ë²¤íŠ¸
    $(document).on("click", ".cancel-interest-btn", function() {
    var grantId = $(this).data("grant-id");
    var $btn = $(this);
    
    $.ajax({
        url: "/api/interest/cancel",
        type: "DELETE",
        data: { grantId: grantId },
        success: function(response) {
            alert(response); // í•´ì œ ì„±ê³µ ë©”ì‹œì§€ ì¶œë ¥
            // í•´ë‹¹ ì¹´ë“œ ì œê±° ë˜ëŠ” ëª©ë¡ ì¬ë¡œë”©
            $btn.closest("li.card").remove();
        },
        error: function(xhr) {
            alert("ê´€ì‹¬ ì·¨ì†Œ ì‹¤íŒ¨! (" + xhr.responseText + ")");
        }
    });
});

    

    </script>
    
    <script>
 // ì‘ë¬¼ ë§¤í•‘ ë°ì´í„° (ì˜ˆì‹œ: ì „ì²´ ë°ì´í„° ëŒ€ì‹  ì¼ë¶€ ì˜ˆì‹œë§Œ ê¸°ì¬)
    var cropMapping = {
    		  "ê°€ì§€": "30770", "ê°“": "30595", "ê²°êµ¬ìƒì¶”": "30596", "ê³ ë“¤ë¹¼ê¸°": "30597", "ê³ ì‚¬ë¦¬": "30598", "ê³ ì¶”(ê½ˆë¦¬ê³ ì¶” ë°˜ì´‰ì„±)": "30599",
    		  "ê³ ì¶”(ë³´í†µì¬ë°°)": "30600", "ê³ ì¶”(ì´‰ì„±ì¬ë°°)": "30601", "ê³°ì·¨": "30602", "ê·¼ëŒ€": "30603", "ëƒ‰ì´": "30604", "ë‹¹ê·¼": "30605",
    		  "ë‘ë¦…": "30606", "ë”¸ê¸°(ì‚¬ê³„ì„±ì—¬ë¦„ì¬ë°°)": "30609", "ë”¸ê¸°(ì´‰ì„±ì¬ë°°)": "30610", "ë§ˆëŠ˜": "30611", "ë§ˆëŠ˜(ìë§ˆëŠ˜)": "30612", "ë©œë¡ ": "30613",
    		  "ë¬´": "30614", "ë¬´(ê³ ë­ì§€ì¬ë°°)": "30615", "ë¯¸ë‚˜ë¦¬": "30616", "ë°°ì¶”": "30618", "ë°°ì¶”(ê³ ë­ì§€ì¬ë°°)": "30619", "ë¶€ì¶”": "30620",
    		  "ë¸Œë¡œì½œë¦¬(ë…¹ìƒ‰ê½ƒì–‘ë°°ì¶” ê³ ë­ì§€ì¬ë°°)": "30621", "ë¸Œë¡œì½œë¦¬(í‰ì•¼ì§€ì¬ë°°)": "30622", "ë¹„íŠ¸": "30623", "ìƒì¶”": "30624", "ìƒê°•": "30625",
    		  "ì…€ëŸ¬ë¦¬(ì–‘ë¯¸ë‚˜ë¦¬)": "30626", "ìˆ˜ë°•": "30627", "ì‹œê¸ˆì¹˜": "30628", "ì‹ ì„ ì´ˆ": "30629", "ì‘¥ê°“": "30630", "ì•„ìŠ¤íŒŒë¼ê±°ìŠ¤": "30632",
    		  "ì•„ìš±": "30631", "ì–‘ë°°ì¶”": "30634", "ì–‘íŒŒ": "30633", "ì—°ê·¼": "30635", "ì˜¤ì´": "30636", "ì ì±„": "30638", "ìª½íŒŒ": "30639",
    		  "ì°¸ì™¸": "30640", "ì°¸ì·¨": "30641", "ì²­ê²½ì±„": "30643", "ì¹˜ì»¤ë¦¬(ìŒˆìš© ìì¹˜ì»¤ë¦¬)": "258609", "ì¹˜ì»¤ë¦¬(ì¹˜ì½˜ ë¿Œë¦¬ì¹˜ì»¤ë¦¬)": "30644",
    		  "ì»¬ë¦¬í”Œë¼ì›Œ(ë°±ìƒ‰ê½ƒì–‘ë°°ì¶” ê³ ë­ì§€ì¬ë°°)": "258607", "í† ë€": "30645", "í† ë§ˆí† (ë°©ìš¸í† ë§ˆí† )": "30646", "íŒŒ": "30647", "íŒŒë“œë“ë‚˜ë¬¼": "258611",
    		  "íŒŒìŠ¬ë¦¬(í–¥ë¯¸ë‚˜ë¦¬)": "258608", "íŒŒí”„ë¦¬ì¹´": "30649", "í”¼ë§": "30650", "í˜¸ë°•": "30651", "í˜¸ë°•(ëŠ™ì€í˜¸ë°•)": "30652",
    		  "í˜¸ë°•(ë‹¨í˜¸ë°•)": "30653", "ê°ê·¤(ë…¸ì§€ì¬ë°°)": "30654", "ê°ê·¤(ì‹œì„¤ì¬ë°°)": "30655", "ë‹¨ê°": "30656", "ë§¤ì‹¤": "30658", "ë¬´í™”ê³¼(ë…¸ì§€ì¬ë°°)": "30659",
    		  "ë¬´í™”ê³¼(ë¬´ê°€ì˜¨ ì‹œì„¤ì¬ë°°)": "30660","ë°°": "30661", "ë³µìˆ­ì•„": "30662", "ë¸”ë£¨ë² ë¦¬": "258549", "ì‚¬ê³¼": "30663", "ì‚´êµ¬": "30664",
    		  "ì–‘ì•µë‘(ì²´ë¦¬)": "30665", "ìœ ì": "30666", "ìë‘": "30667", "ì°¸ë‹¤ë˜": "30668", "í¬ë„(ë¬´ê°€ì˜¨)": "30669", "í¬ë„(í‘œì¤€ê°€ì˜¨)": "258613",
    		  "í”ŒëŸ¼ì½”íŠ¸": "258633", "í•œë¼ë´‰(ë¶€ì§€í™”)": "30670", "ê¸°ê³„ì´ì•™ì¬ë°°": "30697", "ì§íŒŒì¬ë°°": "30698", "ê°ì": "30699", "ê°•ë‚­ì½©": "30700",
    		  "ê³ êµ¬ë§ˆ": "30701", "ë…¹ë‘": "30702", "ë“¤ê¹¨(ì)": "30607", "ë“¤ê¹¨(ì¢…ì‹¤)": "30703", "ë•…ì½©": "30704", "ë§¥ì£¼ë³´ë¦¬": "30705", "ë©”ë°€": "30706",
    		  "ë°€": "30707", "ìˆ˜ìˆ˜": "30708", "ì˜¥ìˆ˜ìˆ˜": "30709", "ì™„ë‘": "30710", "ìœ ì±„": "30711", "ì¼ë°˜ë³´ë¦¬": "30712", "ì¡°": "30713", "ì°¸ê¹¨": "30714",
    		  "ì½©": "30715", "íŒ¥": "30716", "í’‹ì½©": "30717", "ëŠíƒ€ë¦¬ë²„ì„¯": "30733", "ì–‘ì†¡ì´": "30735", "ì˜ì§€ë²„ì„¯": "30734", "íŒ½ì´": "30736",
    		  "êµ¬ê¸°ì": "30739", "ê¸¸ê²½(ë„ë¼ì§€)": "30740", "ë”ë•(ì–‘ìœ )": "30741", "ë‘ì¶©": "30743", "ì‚°ì•½(ë§ˆ)": "30747", "ì˜¤ë¯¸ì": "30749", "ì²œë§ˆ": "30756",
    		  "í™©ê¸°": "30761"
    };

    // Autocompleteì— ì‚¬ìš©í•  ì‘ë¬¼ëª… ëª©ë¡ ìƒì„±
    var cropNames = Object.keys(cropMapping);

    // jQuery UI Autocomplete ì ìš©
    $(document).ready(function() {
        $("#cropInput").autocomplete({
            source: cropNames,
            minLength: 1, // ì‚¬ìš©ìê°€ ìµœì†Œ 1ê¸€ì ì…ë ¥í•˜ë©´ ì¶”ì²œ ì‹œì‘
            select: function(event, ui) {
                // ì‚¬ìš©ìê°€ í•­ëª©ì„ ì„ íƒí•˜ë©´, ì„ íƒí•œ ì‘ë¬¼ëª…ì„ ì…ë ¥ í•„ë“œì™€ íˆë“  í•„ë“œì— ì„¤ì •
                $("#cropInput").val(ui.item.value);
                $("#userCrop").val(ui.item.value);
                return false; // ê¸°ë³¸ ë™ì‘(ìë™ì™„ì„± í›„ ì…ë ¥ í•„ë“œì— ê°’ ì„¤ì •)ì„ ë°©ì§€í•˜ê³ , ì§ì ‘ ì²˜ë¦¬
            }
        });
    });

    </script>
    
    <script>
    // ì‘ë¬¼ ë§¤í•‘ì€ ì´ë¯¸ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì‚¬ìš©ë˜ê³  ìˆì§€ë§Œ, CropSchedule API í˜¸ì¶œì—ëŠ” ì„ íƒëœ ì‘ë¬¼ëª…ì„ ì´ìš©í•©ë‹ˆë‹¤.
    
    // function to load crop schedule using the selected cropName
    function loadCropScheduleAPI(cropName) {
        if (!cropName || cropName.trim() === "") {
            $("#cropScheduleContent").html("<p>ì¬ë°°ì‘ë¬¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>");
            return;
        }
        $.ajax({
            url: "/api/crop-schedule",
            type: "GET",
            data: { cropName: cropName },
            dataType: "html",
            success: function(response) {
                // ì‘ë‹µìœ¼ë¡œ ë°›ì€ HTML í…œí”Œë¦¿ì„ í•´ë‹¹ ì˜ì—­ì— ì‚½ì…
                $("#cropScheduleContent").html(response);
            },
            error: function() {
                $("#cropScheduleContent").html("<p>ë†ì‘ì—…ì¼ì • ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>");
            }
        });
    }
    
    // ë¬¸ì„œ ë¡œë“œ ì‹œ, ì´ë¯¸ userCrop ê°’ì´ ìˆë‹¤ë©´ API í˜¸ì¶œ
    $(document).ready(function() {
        var userCrop = $("#userCrop").val();
        if (userCrop && userCrop.trim() !== "") {
            loadCropScheduleAPI(userCrop);
        }
        
        // ë§Œì•½ ì¬ë°°ì‘ë¬¼ ì…ë ¥ê°’ì´ ë³€ê²½ë˜ë©´, ë³€ê²½ ì´ë²¤íŠ¸ì— ë”°ë¼ APIë¥¼ ì¬í˜¸ì¶œí•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
        $("#cropInput").on("autocompleteselect", function(event, ui) {
            // ì„ íƒëœ ê°’ì´ íˆë“  í•„ë“œì— ì„¤ì •ë˜ë¯€ë¡œ, ê·¸ ê°’ì„ ì½ì–´ API í˜¸ì¶œ
            var selectedCrop = $("#userCrop").val();
            loadCropScheduleAPI(selectedCrop);
        });
    });
    </script>
	<script>
	function loadDiagnosisHistory() {
	        console.log("ğŸ“¡ AI ì§„ë‹¨ ì´ë ¥ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");

	        fetch("/api/ident/history")
	            .then(response => {
	                if (!response.ok) throw new Error("ì§„ë‹¨ ì´ë ¥ ì‘ë‹µ ì‹¤íŒ¨");
	                return response.json();
	            })
	            .then(data => {
	                const tbody = document.querySelector("#diagHistoryTab tbody");
	                tbody.innerHTML = "";

	                if (!data || data.length === 0) {
	                    tbody.innerHTML = `<tr><td colspan="5">ì§„ë‹¨ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
	                    return;
	                }

	                data.forEach(history => {
	                    const row = document.createElement("tr");

	                    const date = new Date(history.identificationTime);
	                    const formattedDate = date.toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });

	                    const imgName = history.imagePath.split("/").pop();

	                    row.innerHTML = `
	                        <td>${formattedDate}</td>
	                        <td>${history.cropName}</td>
	                        <td>${history.diseaseName}</td>
	                        <td>${history.confidenceScore}%</td>
	                        <td><img src="/uploads/${imgName}" class="img-thumbnail" style="width:100px; height:auto;"></td>
							<td><button class="btn btn-danger btn-sm" onclick="deleteHistory(${history.id})">ì‚­ì œ</button></td>
	                    `;

	                    tbody.appendChild(row);
	                });

	                console.log("âœ… AI ì§„ë‹¨ ì´ë ¥ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ");
	            })
	            .catch(error => {
	                console.error("âŒ ì§„ë‹¨ ì´ë ¥ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
	                const tbody = document.querySelector("#diagHistoryTab tbody");
	                tbody.innerHTML = `<tr><td colspan="5">ì§„ë‹¨ ì´ë ¥ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ</td></tr>`;
	            });
	    }
		
		
		
		function deleteHistory(id) {
		    if (!confirm("ì •ë§ ì´ ì§„ë‹¨ ì´ë ¥ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

		    fetch(`/api/ident/delete/${id}`, {
		        method: "DELETE"
		    })
		    .then(response => {
		        if (!response.ok) throw new Error("ì‚­ì œ ì‹¤íŒ¨");
		        alert("âœ… ì§„ë‹¨ ì´ë ¥ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
		        location.reload(); // ë˜ëŠ” í•´ë‹¹ í–‰ë§Œ remove()
		    })
		    .catch(error => {
		        console.error("âŒ ì‚­ì œ ì˜¤ë¥˜:", error);
		        alert("âŒ ì§„ë‹¨ ì´ë ¥ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
		    });
		}

	</script>		
		
	
	
	
	
	
    <script th:src="@{/js/deulmaru_alram.js}"></script>
    <div th:replace="layout/Footer :: Footer"></div>
</body>
</html>
