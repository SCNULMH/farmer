<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì§€ì›ê¸ˆ ìƒì„¸ ì •ë³´</title>
	
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
		/* ì „ì²´ í˜ì´ì§€ ìŠ¤íƒ€ì¼ */
		body {
		    font-family: Arial, sans-serif;
		}
		
		.support-detail {
			margin-top: 5%;
			margin-bottom: 15%;
		}
		
		/* ì œëª©(ì§€ì›ê¸ˆ ìƒì„¸ ì •ë³´) */
		h1#grantTitle {
		    font-size: 28px;
		    margin-bottom: 10px;
		}
		
		/* ì„œë¸Œ ì •ë³´(ì§€ì—­ ì •ë³´, ì§„í–‰ ìƒíƒœ) */
		.sub-info {
		    font-size: 15px;
		    color: #666;
		    margin: -5px 0 15px;    /* ìœ„ì•„ë˜ ê°„ê²© ì¡°ì • */
		}
		
		/* ìƒíƒœ í‘œì‹œ */
		.status {
		    font-weight: bold;
		    padding: 4px 8px;
		    border-radius: 5px;
		    margin-right: 5px;
		    font-size: 14px;
		}
		.ongoing {
		    background-color: #28a745; /* ë¶€íŠ¸ìŠ¤íŠ¸ë© Success ê³„ì—´ */
		    color: #fff;
		}
		.closed {
		    background-color: #dc3545; /* ë¶€íŠ¸ìŠ¤íŠ¸ë© Danger ê³„ì—´ */
		    color: #fff;
		}
		
		/* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
		table {
		    width: 100%;
		    border-collapse: collapse;
		    margin-top: 10px;
		    background-color: #fff;
		    box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* ì•½ê°„ì˜ ê·¸ë¦¼ì */
		}
		th, td {
		    border: 1px solid #ddd;
		    padding: 12px 15px;
		    vertical-align: top;    /* ë‚´ìš© ìœ„ìª½ ì •ë ¬ */
		}
		th {
		    width: 25%;             /* ì²« ì—´ ê³ ì • í­ (ìƒí™©ì— ë§ê²Œ ì¡°ì •) */
		    background-color: #f7f7f7;
		    font-weight: bold;
		    text-align: left;
		}
		
		/* ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
		.btn-container {
		    margin-top: 20px;
		    text-align: center;
		}
		
		/* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
		.btn {
		    display: inline-block;
		    padding: 10px 15px;
		    background-color: #4CAF50; /* ê¸°ë³¸ ì´ˆë¡ìƒ‰ */
		    color: white;
		    text-decoration: none;
		    border-radius: 5px;
		    margin: 0 5px; /* ë²„íŠ¼ ê°„ê²© */
		    transition: background-color 0.2s ease-in-out;
		}
		.btn:hover {
		    background-color: #45a049;
		}
		
		/*ê´€ì‹¬ ë“±ë¡ ë²„íŠ¼ë§Œ ë³„ë„ ìŠ¤íƒ€ì¼ ì£¼ê³  ì‹¶ìœ¼ë©´(ì„ íƒì‚¬í•­)*/
		#interestBtn {
		    background-color: #ff9800;
		}
		#interestBtn:hover {
		    background-color: #e68900;
		}



		/*  âœ… ì´ì‚­ì´ ë²„íŠ¼ (ì±—ë´‡ í† ê¸€)  */
        .button-isac {
            position: fixed;  /* í™”ë©´ì— ê³ ì • */
            bottom: 0px;      /* í™”ë©´ í•˜ë‹¨ì—ì„œ 20px ë–¨ì–´ì§„ ìœ„ì¹˜ */
            right: 20px;       /* í™”ë©´ ì˜¤ë¥¸ìª½ì—ì„œ 20px ë–¨ì–´ì§„ ìœ„ì¹˜ */
            z-index: 1000;     /* ë‹¤ë¥¸ ìš”ì†Œ ìœ„ì— í‘œì‹œë˜ë„ë¡ ì„¤ì • */
            
        }
        .image-btn-isac {
            width: 150px;
            height: 110px;
            border-radius: 50%;
            border: none;
            background: none;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
            
        }
        .image-btn-isac img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }

        .image-btn-isac span {
            font-size: 17px;
            font-weight: 900;
            color: #000;
            font-family: 'ìµœì• ì²´';
        }

        .image-btn-isac:hover {
            transform: scale(1.1);
            transition: all 0.2s ease-in-out;
            
        }

        /* <!-- âœ… ì±—ë´‡ íŒì—… UI --> */
        /* âœ… ì±—ë´‡ íŒì—… ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .chatbot-container {
            position: fixed;
            bottom: 20px; /* í™”ë©´ í•˜ë‹¨ì—ì„œ 20px ìœ„ */
            right: 20px; /* í™”ë©´ ì˜¤ë¥¸ìª½ì—ì„œ 20px ì™¼ìª½ */
            width: 30%; /* ì±—ë´‡ íŒì—… ë„ˆë¹„ */
            display: none;
            z-index: 1000; /* ë‹¤ë¥¸ ìš”ì†Œ ìœ„ì— í‘œì‹œ */
            overflow: hidden;
        }

        /* âœ… ì±—ë´‡ íŒì—… ìŠ¤íƒ€ì¼ */
        .chatbot-popup {
            background: white;
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
            padding: 10px;
            width: 100%;
            height: 90%;
            border: 1px solid #ddd;
        }

        /* âœ… ë‹«ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .close-chatbot {
            background: none;
            border: none;
            font-size: 26px;
            color: #000;
            cursor: pointer;
            position: absolute;
            left: 10px;
            top: 10px;
        }
        
        .close-chatbot:hover {
        	font-size: 29px;
        	font-weight: bold;
        }



    </style>
</head>
<script th:inline="javascript">
/*<![CDATA[*/
    var serviceKey = /*[[${serviceKey}]]*/ "";
/*]]>*/
</script>




<body>

	<!-- í—¤ë” ì‚½ì… -->
	<div th:replace="layout/header :: header"></div>
	
	<div class="container-sm text-left">
		<div class="support-detail">
		    <h1 id="grantTitle">ì§€ì›ê¸ˆ ìƒì„¸ ì •ë³´</h1>
		    <p class="sub-info">
		        <span id="grantLocation" class="status">ì§€ì—­ ì •ë³´ ì—†ìŒ</span> | 
		        <span id="grantStatus" class="status"></span>
		    </p>
		
		    <table>
		        <tr>
		            <th>ì‹ ì²­ê¸°ê°„</th>
		            <td id="grantPeriod"></td>
		        </tr>
		        <tr>
		            <th>ì£¼ê´€ê¸°ê´€</th>
		            <td id="grantAgency"></td>
		        </tr>
		        <tr>
		            <th>ëŒ€ìƒ</th>
		            <td id="grantTarget"></td>
		        </tr>
		        <tr>
		            <th>ë‹´ë‹¹ë¶€ì„œ</th>
		            <td id="grantDept"></td>
		        </tr>
				<tr>
			    	<th>ìš”ì•½ë‚´ìš©</th>
			    	<td id="grantContent"></td>
				</tr>
		    </table>
		    <div class="btn-container">
		        <a href="/supportApi/support" class="btn">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
		        <a id="infoUrlBtn" href="#" class="btn" target="_blank" style="display: none;">ê³µë¬¸ë³´ê¸°</a>
		        <button id="interestBtn" class="btn">ê´€ì‹¬ ë“±ë¡</button>
		    </div>
		</div>	    
	</div>






	<!-- âœ… ì´ì‚­ì´ ë²„íŠ¼ (ì±—ë´‡ í† ê¸€) -->
     <div class="button-isac mb-5">
        <button class="image-btn-isac" onclick="toggleChatbot()">
            <span>AI ì´ì‚­ì´</span>
            <img src="/image/ì´ì‚­3-removebg-preview.png" alt="ë²„íŠ¼ ì´ë¯¸ì§€">
        </button>
    </div>

    <!-- âœ… ì±—ë´‡ íŒì—… UI -->
    <div id="chatbot" class="chatbot-container">
        <div class="chatbot-popup">
            <button class="close-chatbot" onclick="toggleChatbot()">Ã—</button>
            <iframe src="https://www.nongsaro.go.kr/chatbot/aichatbot.html" width="100%" height="500px" frameborder="0"></iframe>
        </div>
    </div>





    <script>
         // AI ì±—ë´‡ í† ê¸€ JS í•¨ìˆ˜
         function toggleChatbot() {
        var chatbot = document.getElementById("chatbot");

        // ì±—ë´‡ ì°½ì´ ì—´ë ¤ìˆìœ¼ë©´ ìˆ¨ê¸°ê³ , ë‹«í˜€ìˆìœ¼ë©´ í‘œì‹œ
        if (chatbot.style.display === "none" || chatbot.style.display === "") {
            chatbot.style.display = "block";
        } else {
            chatbot.style.display = "none";
        }
    }
    </script>


    <script>
    $(document).ready(function() {
        let seq = "[[${seq}]]";  // Thymeleafì—ì„œ ì „ë‹¬ëœ seq ê°’
        console.log("ğŸ“Œ ìƒì„¸ í˜ì´ì§€ seq ê°’:", seq);

        $.ajax({
        	url: "https://apis.data.go.kr/1390000/youngV2/policyViewV2?typeDv=json&serviceKey=" + serviceKey + "&seq=" + seq,
            type: "GET",
            dataType: "json",
            success: function(response) {
                console.log("ğŸ“Œ ìƒì„¸ API ì‘ë‹µ ë°ì´í„°:", response);

                let grant = response.policy_result;

                $("#grantTitle").text(grant.title || "ì œëª© ì—†ìŒ");
                $("#grantPeriod").text((grant.applStDt || "ê¸°ê°„ ì—†ìŒ") + " ~ " + (grant.applEdDt || "ê¸°ê°„ ì—†ìŒ"));
                $("#grantAgency").text(grant.chargeAgency || "ê¸°ê´€ ì •ë³´ ì—†ìŒ");
                $("#grantTarget").text(grant.eduTarget || "ëŒ€ìƒ ì •ë³´ ì—†ìŒ");
                $("#grantDept").text(grant.chargeDept || "ë‹´ë‹¹ ë¶€ì„œ ì •ë³´ ì—†ìŒ");
                
            	// ë‚´ìš© í‘œì‹œ (ê°œí–‰ ë¬¸ì \n â†’ <br> íƒœê·¸ ë³€í™˜)
                let formattedContent = (grant.contents || "ë‚´ìš© ì—†ìŒ").replace(/\n/g, "<br>");
                $("#grantContent").html(formattedContent);

                // ì§€ì—­ ì •ë³´ ì¶”ê°€ (null ë˜ëŠ” ë¹ˆ ê°’ì´ë©´ "ì „êµ­"ìœ¼ë¡œ ì„¤ì •)
                let locationText = grant.area2Nm && grant.area2Nm.trim() ? grant.area2Nm : "ì „êµ­";
                $("#grantLocation").text(locationText);

                // í˜„ì¬ ìƒíƒœ (ì§„í–‰ ì¤‘ / ë§ˆê°) ê³„ì‚°
                let today = new Date();
                let endDate = new Date(grant.applEdDt);
                if (!isNaN(endDate.getTime()) && today <= endDate) {
                    $("#grantStatus").text("ì§„í–‰ ì¤‘").addClass("ongoing");
                } else {
                    $("#grantStatus").text("ë§ˆê°").addClass("closed");
                }

                // ê³µë¬¸ë³´ê¸° ë²„íŠ¼ ì„¤ì • (infoUrlì´ ìˆì„ ê²½ìš°)
                if (grant.infoUrl && grant.infoUrl.trim()) {
                    $("#infoUrlBtn").attr("href", grant.infoUrl).show();
                }
            },
            error: function() {
                alert("ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        });
    });
    </script>
    
	<script>
	$(document).ready(function() {
	    let seq = "[[${seq}]]";  // ì§€ì›ê¸ˆ ID
	    let userId = "[[${session.user?.userId}]]";  // ì„¸ì…˜ì—ì„œ ë¡œê·¸ì¸í•œ ìœ ì € ì •ë³´
	
	    if (!userId || userId === "null") {
	        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
	        $("#interestBtn").text("ë¡œê·¸ì¸ í•„ìš”").addClass("disabled").prop("disabled", true);
	        return;
	    }
	
	    // âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ, ê´€ì‹¬ ë“±ë¡ ì—¬ë¶€ í™•ì¸
	    $.ajax({
	        url: "/api/interest/check",
	        type: "GET",
	        data: { grantId: seq },
	        success: function(response) {
	            if (response.exists) {
	                // ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆë‹¤ë©´, ì·¨ì†Œ ë²„íŠ¼ìœ¼ë¡œ í‘œì‹œ
	                $("#interestBtn").text("ê´€ì‹¬ ì·¨ì†Œ").removeClass("disabled").prop("disabled", false);
	            }
	        },
	        error: function() {
	            console.log("ê´€ì‹¬ ë“±ë¡ ì—¬ë¶€ í™•ì¸ ì‹¤íŒ¨");
	        }
	    });
	
	    // âœ… ê´€ì‹¬ ë“±ë¡ / ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
	    $("#interestBtn").click(function() {
	        let btn = $(this);
	        let applEdDt = $("#grantPeriod").text().split("~")[1].trim(); // ë§ˆê°ì¼
	
	        // ë²„íŠ¼ í…ìŠ¤íŠ¸ì— ë”°ë¼ ë“±ë¡ ë˜ëŠ” ì·¨ì†Œ ì²˜ë¦¬
	        if (btn.text() === "ê´€ì‹¬ ë“±ë¡") {
	            // ë“±ë¡ ì²˜ë¦¬
	            $.ajax({
	                url: "/api/interest/add",
	                type: "POST",
	                data: { grantId: seq, applEdDt: applEdDt },
	                success: function(response) {
	                    alert(response);
	                    btn.text("ê´€ì‹¬ ì·¨ì†Œ");
	                },
	                error: function(xhr) {
	                    alert("ê´€ì‹¬ ë“±ë¡ ì‹¤íŒ¨! (" + xhr.responseText + ")");
	                }
	            });
	        } else if (btn.text() === "ê´€ì‹¬ ì·¨ì†Œ") {
	            // ì·¨ì†Œ ì²˜ë¦¬
	            $.ajax({
	                url: "/api/interest/cancel",
	                type: "DELETE",
	                data: { grantId: seq },
	                success: function(response) {
	                    alert(response);
	                    btn.text("ê´€ì‹¬ ë“±ë¡");
	                },
	                error: function(xhr) {
	                    alert("ê´€ì‹¬ ì·¨ì†Œ ì‹¤íŒ¨! (" + xhr.responseText + ")");
	                }
	            });
	        }
	    });
	});
	</script>

	<script>
    // âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ, ê´€ì‹¬ ë“±ë¡ ì—¬ë¶€ í™•ì¸
    $.ajax({
        url: "/api/interest/check",
        type: "GET",
        data: { grantId: seq },
        success: function(response) {
            if (response.exists) {
                // ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆë‹¤ë©´, ì·¨ì†Œ ë²„íŠ¼ìœ¼ë¡œ í‘œì‹œ
                $("#interestBtn").text("ê´€ì‹¬ ì·¨ì†Œ").removeClass("disabled").prop("disabled", false);
            }
        },
        error: function() {
            console.log("ê´€ì‹¬ ë“±ë¡ ì—¬ë¶€ í™•ì¸ ì‹¤íŒ¨");
        }
    });

    // âœ… ê´€ì‹¬ ë“±ë¡ / ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    $("#interestBtn").click(function() {
        let btn = $(this);
        let applEdDt = $("#grantPeriod").text().split("~")[1].trim(); // ë§ˆê°ì¼
        let title = $("#grantTitle").text();
        
        // ë²„íŠ¼ í…ìŠ¤íŠ¸ì— ë”°ë¼ ë“±ë¡ ë˜ëŠ” ì·¨ì†Œ ì²˜ë¦¬
        if (btn.text() === "ê´€ì‹¬ ë“±ë¡") {
            // ë“±ë¡ ì²˜ë¦¬
            $.ajax({
                url: "/api/interest/add",
                type: "POST",
                data: { grantId: seq, applEdDt: applEdDt, title: title },
                success: function(response) {
                    alert(response);
                    btn.text("ê´€ì‹¬ ì·¨ì†Œ");
                },
                error: function(xhr) {
                    alert("ê´€ì‹¬ ë“±ë¡ ì‹¤íŒ¨! (" + xhr.responseText + ")");
                }
            });
        } else if (btn.text() === "ê´€ì‹¬ ì·¨ì†Œ") {
            // ì·¨ì†Œ ì²˜ë¦¬
            $.ajax({
                url: "/api/interest/cancel",
                type: "DELETE",
                data: { grantId: seq },
                success: function(response) {
                    alert(response);
                    btn.text("ê´€ì‹¬ ë“±ë¡");
                },
                error: function(xhr) {
                    alert("ê´€ì‹¬ ì·¨ì†Œ ì‹¤íŒ¨! (" + xhr.responseText + ")");
                }
            });
        }
    });
</script>
<script th:src="@{/js/deulmaru_alram.js}"></script>

</body>
</html>
