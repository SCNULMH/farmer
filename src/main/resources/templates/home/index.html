<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>병해충 사전 페이지</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="css/deulmaru_dictionary.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
  <body>
  <!-- 헤더 삽입 (Thymeleaf로 헤더 템플릿 포함) -->
    <div th:replace="layout/header :: header"></div>

    <div class="container my-4">
      <!-- 추천 영역 -->
      <section id="recommendationSection">
        <h2 th:text="${session.user != null} ? '내 맞춤 추천 지원금' : '전체 추천 지원금 Top3'">추천 지원금</h2>
        <ul class="benefit-list d-flex flex-wrap">
          <!-- 동적으로 카드가 삽입됩니다 -->
        </ul>
      </section>
    </div>

    <!-- Thymeleaf를 통해 로그인 여부 플래그 전달 -->
    <script th:inline="javascript">
      var isLoggedIn = /*[[${session.user != null}]]*/ false;
    </script>

    <script>
      // 헬퍼 함수: 지원금의 진행 상태를 계산합니다.
      function getStatus(applEdDt) {
          if (!applEdDt) return "정보 없음";
          var today = new Date();
          var endDate = new Date(applEdDt);
          if (isNaN(endDate.getTime())) return "정보 없음";
          return today <= endDate ? "진행중" : "마감";
      }

      // 추천 API에서 받은 grantId 목록을 바탕으로 외부 지원금 상세 정보를 불러와 카드 생성
      function loadRecommendations(endpoint) {
          var $ul = $("#recommendationSection ul.benefit-list");
          $ul.html("<p>추천 지원금을 불러오는 중...</p>");
          
          $.ajax({
              url: endpoint,
              type: "GET",
              dataType: "json",
              success: function(recommendations) {
                  if (!recommendations || recommendations.length === 0) {
                      $ul.html("<p>추천 지원금이 없습니다.</p>");
                      return;
                  }
                  $ul.empty();
                  // 각 추천 결과에는 grantId와 interestCount가 포함되어 있다고 가정
                  recommendations.forEach(function(item) {
                      var grantId = item.grantId;
                      // 외부 API 호출: 공공데이터포털 지원금 상세 API
                      $.ajax({
                          url: "https://apis.data.go.kr/1390000/youngV2/policyViewV2",
                          type: "GET",
                          dataType: "json",
                          data: {
                              typeDv: "json",
                              serviceKey: "lwFN+9DgtdnDkUuQpxCaemhEBXNKBw/EIeII2WsOlInuroAHa9InabfXhyR365jieyuEEzrb2QYAHP3b3AlrFA==",  // raw 키 사용
                              seq: grantId
                          },
                          success: function(response) {
                              var grant = response.policy_result;
                              var status = getStatus(grant.applEdDt);
                              // 카드 HTML 생성: 기존 CSS 클래스 재사용
                              var cardHtml = `
                                  <li class="card benefit-card">
                                      <div class="card-body">
                                          <h3 class="card-title">${grant.title || "제목 없음"}</h3>
                                          <p class="card-text"><strong>대상 :</strong> ${grant.eduTarget || "대상 정보 없음"}</p>
                                          <p class="date-range"><strong>신청기간 :</strong> ${grant.applStDt || "기간 없음"} ~ ${grant.applEdDt || "기간 없음"}</p>
                                          <p class="card-ongoing">
                                              <strong>진행 상태 :</strong>
                                              <span class="${status === '진행중' ? 'ongoing' : 'closed'}">${status}</span>
                                          </p>
                                          <button class="show-more" onclick="window.location.href='/supportApi/detail/${grant.seq}'">상세보기</button>
                                      </div>
                                  </li>
                              `;
                              $ul.append(cardHtml);
                          },
                          error: function() {
                              console.error("지원금 상세 정보를 불러오지 못했습니다. (grantId: " + grantId + ")");
                          }
                      });
                  });
              },
              error: function() {
                  $ul.html("<p>추천 지원금을 불러오는 데 실패했습니다.</p>");
              }
          });
      }

      // 문서 로드 시 로그인 여부에 따라 적절한 추천 API 호출
      $(document).ready(function() {
          if (isLoggedIn) {
              loadRecommendations("/api/recommendation/personal");
          } else {
              loadRecommendations("/api/recommendation/overall");
          }
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>